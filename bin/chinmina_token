#!/bin/bash
set -ueo pipefail

script_dir=$(dirname "${BASH_SOURCE[0]}")

#
# Retrieves a GitHub token from Chinmina Bridge for the supplied profile name.
# If none is given, the token for the current pipeline is returned
# ("repo:default").
#
# This library function is added to the PATH by the plugin's environment hook.
# The `CHINMINA_TOKEN_LIBRARY_FUNCTION_` variables are set by the environment
# hook to communicate configuration from the plugin's parameters.
#
# A caller may override the URL and audience by passing them directly as
# parameters.
#
# Usage: chinmina_token <profile> [url] [audience]
#
profile_name=${1:-"repo:default"}
url="${2:-${CHINMINA_TOKEN_LIBRARY_FUNCTION_CHINMINA_URL:-}}"
audience="${3:-${CHINMINA_TOKEN_LIBRARY_FUNCTION_AUDIENCE:-chinmina:default}}"

# Validate required parameters
if [[ -z "$url" ]]; then
  echo "Error: chinmina-url not provided in environment or as an argument" >&2
  exit 1
fi

# The Buildkite agent manages the TMPDIR environment variable, and this script
# requires it for caching OIDC tokens.
: "${TMPDIR:?TMPDIR environment variable required}"

# shellcheck source=../lib/cache.bash
source "${script_dir}/../lib/cache.bash"

additional_oidc_claims="pipeline_id,cluster_id,cluster_name,queue_id,queue_key"

# Caches the OIDC token for 5 minutes.
if ! oidc_auth_token="$(cache_read "${BUILDKITE_JOB_ID}")"; then
  # timings are output to stderr, which Git ignores.
  TIMEFORMAT='[oidc = %2Rs]'
  time {
    oidc_auth_token="$(buildkite-agent oidc request-token --claim "${additional_oidc_claims}" --audience "${audience}")"
  }
  cache_write "${BUILDKITE_JOB_ID}" "${oidc_auth_token}"
fi

if [[ "${profile_name}" == repo:* ]]; then
  request_path="token"
else
  request_path="organization/token/${profile_name}"
fi

plugin_version=$(echo "${BUILDKITE_PLUGINS:-}" | jq -r '
  [.[] | keys[0] | select(startswith("github.com/chinmina/chinmina-token-buildkite-plugin#")) | split("#")[1]]
  | first
  // "v.unknown"
')

# POST request to fetch token from Github App
chinmina_response=$(curl --retry 3 --retry-delay 1 --retry-connrefused \
  --silent --show-error --fail \
  --request POST "${url}/${request_path}" \
  --data "" \
  --header "Authorization: Bearer ${oidc_auth_token}" \
  --header "Content-Type: text/plain" \
  --header "Accept: application/json" \
  --header "User-Agent: chinmina-token-buildkite-plugin/${plugin_version}" \
)

token_exists="$(echo "$chinmina_response" | jq 'has("token")')"

if [[ "${token_exists}" == "false" ]]; then
  echo "request failed: no token returned in Chinmina response" >&2
  exit 1
fi

chinmina_token="$(echo "$chinmina_response" | jq -r '.token')"
if [[ ${#chinmina_token} -eq 0 ]]; then
  echo "request failed: empty token returned in Chinmina response" >&2
  exit 1
fi

# ensure that the token is redacted in Buildkite logs
buildkite-agent redactor add <<<"$chinmina_token" 2> /dev/null

echo "${chinmina_token}"
