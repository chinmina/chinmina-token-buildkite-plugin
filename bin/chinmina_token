#!/bin/bash

echo "This starts"
# This script is responsible for getting a token for a given profile (or the default)
profile_name=$1
oidc_cached_path="/tmp/oidc_auth_token_${BUILDKITE_JOB_ID}.cache"
url="https://chinmina.usw2.ci.cultureamp.io" # TODO: Make 'url' configurable from plugin inputs.
args="" # No data is required to fetch the token

if [[ ${profile_name} == "default" || ${profile_name} == "repo:default" ]]; then
  path="token"
else
  path="organization/token/${profile_name}"s
fi

oidc_auth_token=$(cat "$oidc_cached_path")

echo "Buildkite token loaded for org profile: ${profile_name}"

# POST request to fetch token from Github App
chinmina_response=$(curl --silent --show-error --fail \
  --request POST "${url}/${path}" \
  --data "${args}" \
  --header "Authorization: Bearer ${oidc_auth_token}" \
  --header "Content-Type: text/plain" \
  --header "Accept: text/plain")

# Uses jq to filter the json object and retrieve the token value
chinmina_token=$(echo "$chinmina_response" | jq '.token')

if [ $? -ne 0 ]; then
    echo "JSON parsing failed"
    return 1
fi

echo "$chinmina_token"  