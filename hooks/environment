#!/bin/bash

set -ueo pipefail

# Add parameters to the environment so they're available to the chinmina_token helper script
# This means that the plugin can't really be defined twice in step/agent hook, as the values
# defined here will be overwritten by each successive hook execution (i.e. last one wins).
#
# This plugin is designed to be used in the "environment" agent hook, so there's no real desire
# to have multiple versions sets of parameter values.
export CHINMINA_TOKEN_LIBRARY_FUNCTION_CHINMINA_URL="${BUILDKITE_PLUGIN_CHINMINA_TOKEN_CHINMINA_URL?chinmina-url parameter is required}"
export CHINMINA_TOKEN_LIBRARY_FUNCTION_AUDIENCE="${BUILDKITE_PLUGIN_CHINMINA_TOKEN_AUDIENCE?audience parameter is required}"

HOOKS_DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"

export PATH="$PATH:$HOOKS_DIR/../bin"

plugin_read_list() {
  local prefix="$1"
  local i=0
  local parameter="${prefix}_${i}"

  while [[ -n "${!parameter:-}" ]]; do
    echo "${!parameter}"
    i=$((i+1))
    parameter="${prefix}_${i}"
  done
}

while IFS='=' read -r var_name profile; do
  if [[ ! "$var_name" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]]; then
    echo "Invalid variable name: '$var_name'" >&2
    exit 1
  fi
  if [[ -z "$profile" ]]; then
    echo "Empty profile for: '$var_name'" >&2
    exit 1
  fi
  if ! token=$(chinmina_token "$profile"); then
    echo "Token retrieval failed for: '$profile'" >&2
    exit 1
  fi
  export "${var_name}=${token}"
done < <(plugin_read_list BUILDKITE_PLUGIN_CHINMINA_TOKEN_ENVIRONMENT)
